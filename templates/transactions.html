{% extends 'base.html' %}

{% block title %}My Transactions - Expense Tracker{% endblock %}

{% block content %}
<!-- Filter Controls -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
  <div class="d-flex flex-wrap gap-2">
    <select id="yearFilter" class="form-select w-auto">
      <option value="">Select Year</option>
    </select>
    <select id="monthFilter" class="form-select w-auto">
      <option value="">Select Month</option>
      {% for month in range(1, 13) %}
        <option value="{{ month }}">{{ month }}</option>
      {% endfor %}
    </select>
    <input type="text" id="descriptionSearch" class="form-control w-auto" placeholder="Search description...">
    <button class="btn btn-primary" id="applyFilter">Apply</button>
    <button class="btn btn-secondary" id="showAll">Show All</button>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-info" id="exportCsv">
      <i class="fas fa-file-export me-2"></i>Export CSV
    </button>
    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#importCsvModal">
      <i class="fas fa-file-import me-2"></i>Import CSV
    </button>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal" onclick="resetTransactionForm()">
      <i class="fas fa-plus me-2"></i>Add Transaction
    </button>
  </div>
</div>

<!-- Totals -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card shadow-sm p-4 bg-dark bg-opacity-50 rounded-4">
      <h6 class="text-white-50 mb-1">Total Income</h6>
      <h3 id="totalIncome" class="text-success fw-bold">$0.00</h3>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card shadow-sm p-4 bg-dark bg-opacity-50 rounded-4">
      <h6 class="text-white-50 mb-1">Total Expense</h6>
      <h3 id="totalExpense" class="text-danger fw-bold">$0.00</h3>
    </div>
  </div>
</div>

<!-- Transactions Table -->
<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Date</th>
      <th>Category</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="transactionsTableBody"></tbody>
</table>

<!-- Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_transaction_form') }}" id="transactionForm" class="p-3">
        {{ form.hidden_tag() }}
        {{ form.transaction_id(id="transactionId") }}
        <div class="modal-header">
          <h5 class="modal-title" id="addTransactionModalLabel">Add/Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ form.description(class="form-control mb-3", placeholder="Description") }}
          {{ form.amount(class="form-control mb-3", placeholder="Amount") }}
          {{ form.category_id(class="form-select mb-3") }}
          {{ form.date(class="form-control mb-3") }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden Delete Form -->
<form method="POST" id="deleteForm" style="display: none;">
  {{ form.hidden_tag() }}
  <input type="hidden" name="transaction_id" id="deleteTransactionId">
</form>

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1" aria-labelledby="importCsvModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="importCsvForm" method="POST" enctype="multipart/form-data" class="modal-content p-3">
      {{ import_form.hidden_tag() }}
      <div class="modal-header">
        <h5 class="modal-title">Import Transactions from CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ import_form.file(class="form-control", accept=".csv") }}
        <div class="form-text mt-2">Expected CSV: date, description, amount, category_id</div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary w-100">Upload CSV</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/transactions.js') }}"></script>
<script>
  function resetTransactionForm() {
    document.getElementById("transactionId").value = "";
  }

  function deleteTransaction(id) {
    if (confirm("Are you sure you want to delete this transaction?")) {
      document.getElementById("deleteTransactionId").value = id;
      document.getElementById("deleteForm").submit();
    }
  }
</script>
{% endblock %}

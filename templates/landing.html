<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Tracker - My Transactions</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<!-- Toast Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    <div class="toast align-items-center text-white bg-success border-0 show" role="alert">
      <div class="d-flex">
        <div class="toast-body">{{ message }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    {% endfor %}
  {% endwith %}
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Expense Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item">
          <a class="nav-link active" href="/">My Transactions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/analysis">My Analysis</a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">{{ current_user.name }}</a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#">Change Password</a></li>
            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Sign Out</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Main Container -->
<div class="container my-4">
  <h2 class="text-white">My Transactions</h2>

  <form method="POST" action="/" class="d-flex mb-3">
    <input type="number" step="0.01" name="income" class="form-control me-2" placeholder="Set Monthly Income" required>
    <button type="submit" class="btn btn-outline-light">Update Income</button>
  </form>

  <!-- Filters and Add Button -->
  <form method="GET" action="/" class="row g-2 mb-3">
    <div class="col-sm-2">
      <select name="year" class="form-select">
        <option value="">Select Year</option>
        {% for year in years %}
        <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-2">
      <select name="month" class="form-select">
        <option value="">Select Month</option>
        {% for month in months %}
        <option value="{{ month }}" {% if selected_month == month %}selected{% endif %}>{{ month }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-4">
      <input type="text" name="search" class="form-control" placeholder="Search description..." value="{{ search_query or '' }}">
    </div>
    <div class="col-sm-2 d-flex gap-2">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
      <a href="/" class="btn btn-outline-light w-100">Show All</a>
    </div>
    <div class="col-sm-2">
      <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#chooseCategoryModal">
        + Add Expense
      </button>
    </div>
  </form>

  <!-- Summary -->
  <div class="d-flex justify-content-around text-white mb-4">
    <div><h5>Total Income</h5><p>${{ monthly_income }}</p></div>
    <div><h5>Total Expense</h5><p>${{ total_expense }}</p></div>
    <div><h5>Remaining Balance</h5><p>${{ monthly_income - total_expense }}</p></div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-light">
            <tr>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in expenses %}
            <tr>
              <td>{{ expense.category }}</td>
              <td>{{ expense.description }}</td>
              <td>${{ expense.amount }}</td>
              <td>{{ expense.date }}</td>
              <td>
                <a href="{{ url_for('edit_expense', id=expense.id) }}" class="btn btn-sm btn-warning">Edit</a>
                <form action="{{ url_for('delete_expense', id=expense.id) }}" method="POST" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Choose Category Modal -->
<div class="modal fade" id="chooseCategoryModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose a Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="row">
          {% set categories = [
            {'name': 'Food', 'icon': 'üçî'},
            {'name': 'Transport', 'icon': 'üöó'},
            {'name': 'Rent', 'icon': 'üè†'},
            {'name': 'Mobile', 'icon': 'üì±'},
            {'name': 'Education', 'icon': 'üéì'},
            {'name': 'Travel', 'icon': '‚úàÔ∏è'},
            {'name': 'Entertainment', 'icon': 'üé¨'},
            {'name': 'Shopping', 'icon': 'üõçÔ∏è'},
            {'name': 'Health', 'icon': 'üè•'},
            {'name': 'Other', 'icon': '‚ú®'}
          ] %}
          {% for cat in categories %}
          <div class="col-4 mb-3">
            <button type="button" class="btn btn-outline-light w-100" onclick="selectCategory('{{ cat.name }}')">
              {{ cat.icon }} {{ cat.name }}
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addExpenseForm" action="/add_expense" method="POST">
          <input type="text" id="selected-category" name="category" class="form-control mb-3" placeholder="Category" readonly required>
          <input type="number" step="0.01" name="amount" class="form-control mb-3" placeholder="Amount" required>
          <input type="text" name="description" class="form-control mb-3" placeholder="Description" required>
          <input type="date" name="date" class="form-control mb-3" required>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="addExpenseForm" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function selectCategory(category) {
  document.getElementById('selected-category').value = category;
  const chooseModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('chooseCategoryModal'));
  chooseModal.hide();
  const addModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addExpenseModal'));
  addModal.show();
}
</script>

</body>
</html>
